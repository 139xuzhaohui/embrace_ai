
### spring-ai-alibaba
- æ„Ÿè§‰æ•´åˆäº†å¾ˆå¤šçš„ä½¿ç”¨ --ä¸»è¦æ˜¯agent, å¯ä»¥äº†è§£ä¸‹ å¦‚æœbuild a agentçš„ä¸€ä¸ªæµç¨‹
- å¼€å§‹å­¦ä¹ ï¼



 ### Chatbot

 ### agent

 ### workFlow

 ### Muti-Agent


 #### 1ã€å¼€å§‹å®šä¹‰ä¸€ä¸ªå·¥å…·(function / tool)

> **org.springframework.ai.tool.function.FunctionToolCallback**
 
```java
  public class FunctionToolCallback<I, O> implements ToolCallback {
   
    public FunctionToolCallback(ToolDefinition toolDefinition, @Nullable ToolMetadata toolMetadata, Type toolInputType, BiFunction<I, ToolContext, O> toolFunction, @Nullable ToolCallResultConverter toolCallResultConverter) {

        Assert.notNull(toolDefinition, "toolDefinition cannot be null");
        Assert.notNull(toolInputType, "toolInputType cannot be null");
        Assert.notNull(toolFunction, "toolFunction cannot be null");
        // ä»¥ä¸Šå¿…é¡»ä¼ é€’

        this.toolDefinition = toolDefinition;
        this.toolMetadata = toolMetadata != null ? toolMetadata : DEFAULT_TOOL_METADATA;
        this.toolFunction = toolFunction;
        this.toolInputType = toolInputType;
        this.toolCallResultConverter = toolCallResultConverter != null ? toolCallResultConverter : DEFAULT_RESULT_CONVERTER;
    }
```

- 1ã€**ToolDefinition**
  1. ToolDefinition toolDefinitionï¼ˆå¿…éœ€ï¼‰
  2. ä½œç”¨ï¼š å®šä¹‰å·¥å…·çš„åŸºæœ¬ä¿¡æ¯ï¼Œå‘Šè¯‰ AI è¿™ä¸ªå·¥å…·æ˜¯ä»€ä¹ˆ
  3. åŒ…å«å†…å®¹ï¼š **nameã€descriptionã€inputSchema** (è¾“å…¥å‚æ•°çš„ JSON Schema), ä¸‹é¢ä¼šæœ‰demo
- 2ã€**ToolMetadata**
  - for æ§åˆ¶å·¥å…·è¡Œä¸º	returnDirect=false/true *ï¼ˆæ˜¯å¦è®©å·¥å…·é¢å¤–è¡¥å……ä¸€äº›å›å¤å§) æ¨ç†ã€åœºæ™¯æ‹“å±•å•¥çš„*
- 3ã€**toolInputType**
  - for å‚æ•°ç±»å‹
- 4ã€**BiFunction**
  - for å®é™…æ‰§è¡Œé€»è¾‘
- 5ã€**ToolCallResultConverter**
  - forç»“æœæ ¼å¼è½¬æ¢


> BiFunction is ä¸€ä¸ªå‡½æ•°å¼æ¥å£

```java
@FunctionalInterface
public interface BiFunction<T, U, R> {
 apply()....
}
```

> ToolDefinition demo

```java
ToolDefinition toolDefinition = new ToolDefinition() {
    @Override
    public String name() {
        return "get_weather";
    }

    @Override
    public String description() {
        return "æŸ¥è¯¢æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯";
    }

    @Override
    public String inputSchema() { // âš ï¸ è¿™ä¸ªè›®é‡è¦çš„,éœ€è¦è¯†åˆ«çš„å‚æ•°ï¼ˆåŠ¨æ€å‚æ•°ï¼‰
        return """
            {
                "type": "object",
                "properties": {
                    "city": {
                        "type": "string",
                        "description": "åŸå¸‚åç§°"
                    }
                },
                "required": ["city"]
            }
            """;
    }
};
```


> 1ã€**FunctionTools**

```java
public class WeatherTools extends FunctionToolCallback<WeatherRequest, CommonResponse> {

  // **å®ç°ä»–çš„super,é‡ç‚¹æ˜¯å¯¹äºå·¥å…·çš„å®šä¹‰ï¼Œå’Œå·¥å…·çš„å®ç°**

}

    private static BiFunction<WeatherRequest, ToolContext, CommonResponse> createWeatherFunction(
            WeatherService weatherService) {

        return (request, context) -> {
            System.out.println("\nğŸ”§ ========== å¤©æ°”å·¥å…·è°ƒç”¨-WeatherTools ========== ");
            System.out.println("ğŸ“¥ åŸå¸‚: " + request.getRequest());
            String result = weatherService.getWeather(request.getRequest());
            System.out.println("ğŸ“¤ è¾“å‡º:\n" + result);
            System.out.println("=================å¤©æ°”å·¥å…·è°ƒç”¨ç»“æŸ===================\n");

            return CommonResponse.of(result);
        };
    }


```
**ToolContext é‡Œå¿…é¡»å’ŒinputSchema ä¸­çš„properties è¦matchä¸Šï¼Œ ä¸ç„¶è§£æä¸å‡ºæ¥çš„**


 #### 2ã€å¼€å§‹å®šä¹‰ä½ è‡ªå·±çš„chatmodel
> ä¸€ç§æ˜¯defaultçš„ï¼Œä¸€ç§æ˜¯æŒ‡å®šæ¨¡å‹,å¹¶ä¸”å¯ä»¥åŠ å…¥è‡ªå·±çš„ä¸€äº›options

- baseç±»

â‰ˆ
public interface Model<TReq extends ModelRequest<?>, TRes extends ModelResponse<?>> {
    TRes call(TReq request);
}

public interface ChatModel extends Model<Prompt, ChatResponse>, StreamingChatModel {

 default String call(String message) {
        Prompt prompt = new Prompt(new UserMessage(message));
        Generation generation = this.call(prompt).getResult();
        return generation != null ? generation.getOutput().getText() : "";
    }

    default String call(Message... messages) {
        Prompt prompt = new Prompt(Arrays.asList(messages));
        Generation generation = this.call(prompt).getResult();
        return generation != null ? generation.getOutput().getText() : "";
    }
```

```java
public class Prompt implements ModelRequest<List<Message>> {
    private final List<Message> messages;
    @Nullable
    private ChatOptions chatOptions;

    public Prompt(String contents) {
        this((Message)(new UserMessage(contents)));
    }

    public Prompt(Message message) {
        this(Collections.singletonList(message));
    }

    public Prompt(List<Message> messages) {
        this((List)messages, (ChatOptions)null);
    }

    @Nullable
    public ChatOptions getOptions() {
        return this.chatOptions;
    }

    public List<Message> getInstructions() {
        return this.messages;
    }


    public class DashScopeChatModel implements ChatModel {

    }

        private static DashScopeApi getDashScopeApi() {
        String apiKey = "sk-lalallahhhh";
        // è¿™ä¸ªapi ä¹Ÿå¯ä»¥çœ‹ä¸€ä¸‹ï¼
        return DashScopeApi.builder()
                .apiKey(apiKey)
                .build();
    }

    public static DashScopeChatModel defaultBuild() {
        return DashScopeChatModel.builder()
                .dashScopeApi(getDashScopeApi())
                .build();
    }


public class DashScopeApi {

// ä¸»è¦æ˜¯çœ‹ä½ åº•å±‚ç”¨çš„ä»€ä¹ˆæ¨¡å‹ã€‚ apiKey å’ŒapiUrl æ˜¯å¿…è¦çš„

	private static final Predicate<String> SSE_DONE_PREDICATE = "[DONE]"::equals;

	// Store config fields for mutate/copy
	private final String baseUrl;

	private final ApiKey apiKey;

	private final String completionsPath;

	private final String embeddingsPath;

	private final MultiValueMap<String, String> headers;
}

public class DashScopeModel {

// å®šä¹‰äº†äº›æšä¸¾ ï¼Œabout èŠå¤©æ¨¡å‹çš„åç§°ï¼Œå›¾ç‰‡ã€è§†ã€éŸ³ã€é¢‘çš„æ¨¡å‹æœ‰å“ªäº›ã€embeddingTextType-- å‘é‡æ–‡æ¡£ç±»å‹

}

public class DashScopeChatOptions implements ToolCallingChatOptions {

 // å…³äºæ¨¡å‹çš„ä¸€äº›å¯é€‰é…ç½®å¦‚ï¼š *temperatureã€seedã€topPã€maxTokensã€è¿˜æœ‰ä¸ªhttpHeaders = new HashMap<>();* ç»™å¤§å®¶ç”¨

}

// æ€ä¹ˆæ„é€ è‡ªå·±çš„ cahtmodel
public void buildMyModelWithTools() {
 DashScopeChatOptions options = DashScopeChatOptions.builder()
                .withModel("qwen-plus")  // todo-è¿™é‡Œçš„æ¨¡å‹æ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥æ˜¯è‡ªå·±çš„ï¼Ÿï¼Ÿï¼Ÿ æ¨¡å‹åç§°å§--ä¸ºå•¥ä¸æ˜¯æšä¸¾ï¼Ÿï¼Ÿï¼Ÿ
                .withTemperature(0.7)
                .toolCallbacks(List.of(tools))  // å…³é”®ï¼šåœ¨è¿™é‡Œæ³¨å†Œå·¥å…·
                .build();
 return DashScopeChatModel.builder()
                .dashScopeApi(getDashScopeApi())
                .defaultOptions(options)

}
```

#### 3ã€å…¶å®ä½ å°±å¯ä»¥è°ƒç”¨model.call()ï¼› é¢å¤–çš„ä½ å¯ä»¥åŠ ä¸€äº›agent,å»å¸®ä½ ä¸°å¯Œæ¨¡å‹çš„è¾“å‡º
##### Agent
> - spring ä¸­agentçš„å®šä¹‰ï¼Œ åŸºç±»æ˜¯Agent -- ç»§è€Œå®æ—¶baseagent(FlowAgentã€LoopAgentã€LlmRoutingAgentã€ å¹¶è¡Œçš„ã€ é¡ºåºçš„....) åœ¨å°±æ˜¯ å„ç±»çš„ RecatAgentã€A2aRemoteAgent
> - https://java2ai.com/docs/overview ç›´æ¥çœ‹è¿™ä¸ªå§ï¼ï¼ï¼
 
 > ReactAgent

```java
public class ReactAgent extends BaseAgent {
  ...
	private final AgentToolNode toolNode;
	private List<? extends Hook> hooks;
```

<img width="1928" height="1398" alt="image" src="https://github.com/user-attachments/assets/146fff34-d97a-447b-a3f6-6877c4825836" />

- å¤§æ¦‚çš„ä½¿ç”¨ç‚¹:
- <img width="718" height="1202" alt="image" src="https://github.com/user-attachments/assets/e3e7b095-d152-4a1c-aa6a-7ec2371597ee" />



- ReactAgent çš„å·¥ä½œåŸç†
  Spring AI Alibaba ä¸­çš„ReactAgent åŸºäº Graph è¿è¡Œæ—¶æ„å»ºã€‚Graph ç”±èŠ‚ç‚¹ï¼ˆstepsï¼‰å’Œè¾¹ï¼ˆconnectionsï¼‰ç»„æˆï¼Œå®šä¹‰äº† Agent å¦‚ä½•å¤„ç†ä¿¡æ¯ã€‚Agent åœ¨è¿™ä¸ª Graph ä¸­ç§»åŠ¨ï¼Œæ‰§è¡Œå¦‚ä¸‹èŠ‚ç‚¹ï¼š
  Model Node (æ¨¡å‹èŠ‚ç‚¹)ï¼šè°ƒç”¨ LLM è¿›è¡Œæ¨ç†å’Œå†³ç­–
  Tool Node (å·¥å…·èŠ‚ç‚¹)ï¼šæ‰§è¡Œå·¥å…·è°ƒç”¨
  Hook Nodes (é’©å­èŠ‚ç‚¹)ï¼šåœ¨å…³é”®ä½ç½®æ’å…¥è‡ªå®šä¹‰é€»è¾‘

<br>
<img width="600" height="1318" alt="image" src="https://github.com/user-attachments/assets/eb50c3b9-6574-4bf6-a4fc-3d71a0b4a145" />

<br>
<img width="2036" height="1638" alt="image" src="https://github.com/user-attachments/assets/253cc792-ea7d-4077-a522-6d391b9711e6" />
